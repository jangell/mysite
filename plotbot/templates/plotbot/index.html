{% extends "plotbot/layout.html" %}
{% load static %}

{% block head_bottom %}

<title>PlotBot | Spectral plotting</title>
<!-- plotly cdn -->
<!-- TODO: move these onsite -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script> <!-- for autocomplete -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> <!-- autocomplete css -->
<script src="{% static 'plotbot/js/plot_spec.js' %}"></script> <!-- main script with classes and everything for this all to work -->
<link rel="stylesheet" href="{% static 'plotbot/css/index.css' %}"> <!-- all of the custom page styling -->


{% endblock %}

{% block body %}
{% csrf_token %}

<style>
</style>
<div class="all_tools">
	<div class="toolbar">
		<ul class="tabs">
			<li class="tab" for="global_tools" id="global_tab">Plot Settings</li>
			<li class="tab" for="spec_tools" id="spec_tab">Spec Settings</li>
			<li class="tab default_tab" for="add_tools" id="add_tab">Add Spec</li>
			<li class="tab" for="anno_tools" id="anno_tab">Annotations</li>
		</ul>
		
		<div class="toolset_container">
			<div class="toolset" id="global_tools">
				<!-- binding inputs for global tools -->

				<div class="tools_col">
					<div class="setting">
						<label>Title</label>
						<input class="right" target="title" placeholder="no title">
					</div>
					<div class="setting">
						<label>X Label</label>
						<input class="right" target="xlabel" value="Wavenumber (cm<sup>-1</sup>)" placeholder="no x label">
					</div>
					<div class="setting">
						<label>Y Label</label>
						<input class="right" target="ylabel" value="Intensity" placeholder="no y label">
					</div>
					<div class="setting">
						<label>X Range</label>
						<div class="right" id="x_range">
							<input target="xmin" type=number step=any placeholder="auto">
							<span>-</span>
							<input target="xmax" type=number step=any placeholder="auto">
						</div>
					</div>
					<div class="setting">
						<label>Y Range</label>
						<div class="right" id="y_range">
							<input target="ymin" type=number step=any placeholder="auto">
							<span>-</span>
							<input target="ymax" type=number step=any placeholder="auto">
						</div>
					</div>
				</div>

				<div class="tools_col">

					<div class="setting">
						<label>Show Legend</label>
						<input type=checkbox class="right" target="show_legend" checked>
					</div>
					<div class="setting">
						<label>Show Grid</label>
						<input type=checkbox class="right" target="show_grid" checked>
					</div>

				</div>

				<div class="tools_col">
					<!-- this column is for advanced settings -->
					<div class="setting">
						<label>Left Margin</label>
						<input type=number class="right" target="left_margin" value=70>
					</div>
					<div class="setting">
						<label>Right Margin</label>
						<input type=number class="right" target="right_margin" value=40>
					</div>
					<div class="setting">
						<label>Top Margin</label>
						<input type=number class="right" target="top_margin" value=60>
					</div>
					<div class="setting">
						<label>Bottom Margin</label>
						<input type=number class="right" target="bottom_margin" value=80>
					</div>

				</div>

			</div>

			<div class="toolset" id="spec_tools">
				
				<div id="spec_config_example" class="spec_config showing_config">

					<div class="tools_col">
						<!-- this column is for general settings -->
						<div class="setting">
							<h4 class="col_title" target="spec_name">No Spectrum Selected</h4>
						</div>
						<div class="setting">
							<label>Show</label>
							<input type=checkbox class="right" target="show" checked>
						</div>
						<div class="setting">
							<label>Label</label>
							<input class="right" target="label" placeholder="no label">
						</div>
						<div class="setting">
							<label>Line Width</label>
							<input class="right" target="line_width" type=number min=0 value=2>
						</div>
						<div class="setting">
							<label>Color</label>
							<input type=color class="right" target="color">
						</div>
						<div class="setting">
							<label>Opacity</label>
							<input type=number class="right" min=0 max=1 value=1 step=any target="opacity">
						</div>
					</div>

					<div class="tools_col">
						<div class="preprocess_list">
							<div class="preproc_selector" for="crop"><h4 class="preproc_name">Crop</h4></div>
							<div class="preproc_selector" for="savgol"><h4 class="preproc_name">Savitzky-Golay Filter</h4></div>
							<div class="preproc_selector" for="norm"><h4 class="preproc_name">Normalization</h4></div>
							<dib class="preproc_selector" for="offset"><h4 class="preproc_name">Offset</h4></dib>
						</div>
					</div>

					<div class="tools_col">

						<div class="preproc_settings" name="crop">
							<div class="setting">
								<div class="col_title">Crop</div>
							</div>
							<div class="setting">
								<label>Run</label>
								<input type=checkbox target="run">
							</div>
							<div class="setting">
								<label>x<sub>min</sub></label>
								<input type=number target="xmin" value=100>
							</div>
							<div class="setting">
								<label>x<sub>max</sub></label>
								<input type=number target="xmax" value=1200>
							</div>
						</div>

						<div class="preproc_settings" name="savgol">
							<div class="setting">
								<div class="col_title">Savitzky-Golay Filter</div>
							</div>
							<div class="setting">
								<label>Run</label>
								<input type=checkbox target="run">
							</div>
							<div class="setting">
								<label>Window Size</label>
								<input type=number target="window" value=5 min=5 max=11 step=2>
							</div>
						</div>

						<div class="preproc_settings" name="norm">
							<div class="setting">
								<div class="col_title">Normalization</div>
							</div>
							<div class="setting">
								<label>Run</label>
								<input type=checkbox target="run">
							</div>
							<div class="setting">
								<label>Lower Limit</label>
								<input type=number step=any target="lower" value=0>
							</div>
							<div class="setting">
								<label>Upper Limit</label>
								<input type=number step=any target="upper" value=1>
							</div>
						</div>

						<div class="preproc_settings" name="offset">
							<div class="setting">
								<div class="col_title">Offset</div>
							</div>
							<div class="setting">
								<label>Run</label>
								<input type=checkbox target="run">
							</div>
							<div class="setting">
								<label>Offset</label>
								<input type=number value=1 step=any target="offset" value=1>
							</div>
						</div>
					</div>

				</div>

			</div>

			<div class="toolset" id="add_tools">
				<!-- add from local file -->
				<div class="tools_col">

					<div class="setting">
						<h4 class="col_title">Add from file</h4>
					</div>

					<!-- 
					select file
					
					name in list (default: filename) (d)
					
					add button
					cancel button

					TODO: Multi-add! list, where each item is a file and it changes css as it loads in, with filename and label as options
					TODO: add-by-url
					-->

					<div class="setting">
						<label>File Input</label>
						<input type=file accept=".csv" target="local_file">
					</div>

					<div class="setting">
						<label>Spec Name</label>
						<input class="readonly_without_file required wide_field" target="menu_name" title="This is the name to be displayed in the spectra list on the right" placeholder="Required" readonly>
					</div>

					<div class="setting">
						<button class="setting_button" id="add_from_file" disabled>Add</button>
						<button class="setting_button" id="cancel_add" disabled>Cancel</button>
					</div>

				</div>

				<!-- add from database (slim to start) -->
				<!-- quick add -->
				<!-- explanatory text about managing slim vs full -->
				<!-- load-full button with loading bar (actually, just fill up the button/div-as-button itself!) -->
				<div class="tools_col">

					<div class="setting">
						<h4 class="col_title">Add from database</h4>
					</div>
					
					<!-- interactive list of all spectra -->
					<div class="db_list">
						<div class="table_row head_row">
							<div class="db_id">ID</div>
							<div class="db_name">Name</div>
							<div class="db_source">Source</div>
							<div class="db_wav">&lambda;</div>
						</div>
						<div class="scrollable">
						{% for spec in specs %}
							<div class="table_row db_spec_row">
								<div class="db_id">{{spec.spec_id}}</div>
								<div class="db_name">{{spec.name}}</div>
								<div class="db_source">{{spec.source}}</div>
								<div class="db_wav">{{spec.wavelength}}</div>
							</div>
						{% endfor %}
						</div>
					</div>

					<script>
						// select db row on click
						$('.db_spec_row').click(function(){
							$(this).siblings('.selected_row').removeClass('selected_row');
							$(this).addClass('selected_row');
						});
					</script>

					<div class="setting">
						<button class="setting_button" id="add_from_db" disabled>Add</button>
						<button class="setting_button" id="cancel_db_add" disabled>Cancel</button>
					</div>

				</div>
			</div>

			<div class="toolset" id="anno_tools">

			</div>

		</div>
	</div>

	<div class="spec_list" id="spec_list">
		<div class="table_row head_row">
			<div class="text">Name</div>
			<div class="color">Color</div>
			<div class="showing">Show</div>
		</div>
	</div>
	<!-- put quick-add and remove at the bottom of the spec list div -->
</div>

<div id="plot_holder">

</div>



<script>
// handle all aesthetic properties & changes
$(document).ready(function(){

	// tab clicking functionality
	$('.tab').click(function(){
		// toggle tab css
		$('.selected_tab').removeClass('selected_tab');
		$(this).addClass('selected_tab');
		
		// turn on the right tab content
		let target_id = '#' + $(this).attr('for');
		$('.showing_toolset').removeClass('showing_toolset');
		$(target_id).addClass('showing_toolset');
	});
	// start with default tab
	$('.default_tab').click();



	// preproc clicking functionality
	// this syntax is to apply the function before the .preproc_selector has been inserted into the page
	$('#spec_tools').on('click', '.preproc_selector', function(){
		// toggle selector css
		$('.selected_preproc').removeClass('selected_preproc');
		$(this).addClass('selected_preproc');

		// toggle settings css
		let target_sel = '[name=' + $(this).attr('for') + ']';
		// search through tree, because each specConfig (the other ones are hidden) has the same layout
		$('.selected_preproc_settings').removeClass('selected_preproc_settings');
		$(this).closest('.spec_config').find(target_sel).addClass('selected_preproc_settings');
	});


	// set running / not running preprocess css
	$('#spec_tools').on('change', '[target=run]', function(){
		let running = this.checked;
		let preproc_name = $(this).closest('.preproc_settings').attr('name');
		// bubble up until we find the specConfig tools
		let preproc_selector = $(this).closest('.spec_config').find('[for=' + preproc_name + ']');
		if(running){
			preproc_selector.addClass('running_preproc');
		}
		else{
			preproc_selector.removeClass('running_preproc');
		}
		// update that preprocess's css based on new value of [target=run]
	});


	// connect show checkboxes in list and in specConfig
	// commenting this out and disabling the checkbox in the list because they get out of sync
	/*
	$('#spec_list').on('change', '.showing input[type=checkbox]', function(){
		// find the spec id
		let row_id = $(this).closest('.table_row').attr('id');
		let config_id = '#specconfig_' + row_id.split('speclist_')[1];
		let box = $(config_id).find('[target=show]');
		box.attr('checked', this.checked);
		box.change(); // without this, the event doesn't fire
	});
	*/

});
</script>


<script>
// non-aesthetic (functional) code

var qz = 2481;	// quartz
var al = 51;	// albite
var am = 100;	// amicite
var startWith = []; // list of specIds to autopopulate chart
startWith.push(qz);
startWith.push(al);
startWith.push(am);


var ph = new PlotHandler($('#pc_target'),$('#sl_target'),$('#sc_target'),$('#plot_holder'));
ph.initialize();

// stop <input type=number> from changing on scroll
$(document).on("wheel", "input[type=number]", function (e) {
    $(this).blur();
});



// the .disable_without_file inputs are readonly (disabled but still propagating click events) until a spectrum is chosen
$('.disable_without_file').click(function(){
	if($(this).is('[readonly]')){
		alert('Menu name, wavelength, and label fields can only be set when a file has been selected');
	}
});

// handle what happens when a file is added to the file input
$('[target=local_file]').change(function(){
	let files = document.querySelector('input[target=local_file]').files;
	// remove readonly & disabled if there's a file chosen
	if(files.length){
		$('.readonly_without_file').attr('readonly', false);
		$('.add_button').attr('disabled', false);
		// TODO: only enable add button if menu name is not empty
	}
	else{
		$('.readonly_without_file').attr('readonly', true);
		$('.add_button').attr('disabled', true);
	}

	// cool stuff - try and autofill name, wavelength, and label

	// check that file actually _is_ uploaded
	if(!(files.length)){
		return;
	}

	let file = files[0];
	let fname = file.name;

	let namestring = fname.slice(0,-4); // name without extension

	// try and parse name & wavelength out of it
	let parts = namestring.split('_');
	let name = '';
	let wav = '';

	// first option: one of the parts is {wavelength}nm, everything before is name
	for(let i = 0; i < parts.length; i++){
		if(parts[i].slice(-2,parts[i].length) === 'nm'){
			// join all parts from 0 to i and convert to Title Case
			let name_list = []
			for(let j = 0; j < i; j++){
				name_list.push(parts[j].charAt(0).toUpperCase() + parts[j].slice(1));
				debugger;
			}
			name = name_list.join(' ');
			wav = parts[i];
			foundStrings = true;
		}
	}

	// TODO: next option: one of the parts is {wavelength} (only 532 or 785), everything before is name

	let to_str = name;
	if(wav !== ''){
		to_str += ' ('+wav+')';
	}
	$('[target=menu_name]').val(to_str);

});

//  handle what happens when the button gets hit
$('#add_from_file').click(function(){
	let files = document.querySelector('input[target=local_file]').files;
	
	// check that file actually _is_ uploaded
	if(!(files.length)){
		alert('No file uploaded');
		return;
	}

	let file = files[0];
	let fname = file.name;

	// check that it's a csv type
	if(fname.slice(-4,fname.length) !== '.csv'){
		alert('File must be .csv');
		$('[target=local_file]').val('');	// clear the file that was there
		return;
	}

	let menu_name = $('[target=menu_name]').val();
	if(menu_name === ''){
		alert('Name is a required field. Without it, the spectrum has nothing to identify it in the list.');
		$('[target=menu_name]').focus();
		return;
	}

	// actually add the thing
	ph.addSpecFromFile(menu_name, file);

	// clear the fields
	$('[target=local_file]').val('');
	$('[target=menu_name]').val('');

	// fire change event for file input
	$('[target=local_file]').change();
});

// handle the cancel button
$('#cancel_add').click(function(){
	$('[target=local_file]').val('');
	$('[target=menu_name]').val('');
	// fire change event for file input
	$('[target=local_file]').change();
});


$(document).ready(function(){
	// load database into modal_db_tbody at page load (for now)
	/*
	{% for spec in specs %}
	$('#modal_db_tbody').append(modalDbRow('{{spec.spec_id}}', '{{spec.name}}', '{{spec.source}}', '{{spec.wavelength}}'));
	quick_add_list.push({'label':'{{spec.name}} - {{spec.wavelength}}nm','value':'{{spec.spec_id}}'});
	{% endfor %}
	// this has to go to the end because it's going to tie into plothandler and all those rows
	$('.modal_db_row').click(function(){
		var id = $(this).find('.modal_db_id').html();
		console.log(id);
		ph.addSpecByDbId(id);
		$('.modal_bg').hide();
		// add spectrum to plothandler
	});

	function updateFilters(){

		// show 'loading' gif

		var wv = $('#wv_select').val();
		var str = $('#name_select').val().toLowerCase();

		if(wv == 'all'){
			// show all wavelengths
			$('.modal_db_row').show();
			// then filter by name
			$('.modal_db_row').each(function(){
				if($(this).find('.modal_db_name').html().toLowerCase().match(str)){
					$(this).show();
				}
				else{
					$(this).hide();
				}
			});
		}
		else{
			$('.modal_db_row').each(function(){
				if($(this).find('.modal_db_wv').html() != wv){
					$(this).hide();
				}
				else{
					// this is where filter-by-name comes in
					if($(this).find('.modal_db_name').html().toLowerCase().match(str)){
						$(this).show();
					}
					else{
						$(this).hide();
					}
				}
			});
		}
		// hide 'loading' gif

	}
	// wavelength filter
	$('#wv_select').change(function(){
		updateFilters();
	});
	$('#name_select').on('input',function(){
		updateFilters();
	});
	
	*/

	// development tool: autopopulate
	for(let i = 0; i < startWith.length; i++){
		ph.addSpecByDbId(startWith[i]);	
	}


});


// testing ground for new code

// nothing below here matters if we're doing plotly (except for saving state sometime in the future)
// pass form data as json
$(function() {

	// This takes all settings and passes it over to the server, and then updates the plot holder with the image url returned by the server
	$('#plot_form').submit(function() {
		var form_data = $('#plot_form').serializeArray();
		to_json = {};
		for(var i = 0; i < form_data.length; i++)
			to_json[form_data[i]['name']] = form_data[i]['value'];
			string_data = JSON.stringify(to_json);
			// ajax the stringified data

			//$('#plot_placeholder').show();
			/*
			$.get({
				url:'make_plot',
				data:to_json,
				success:function(response){
					$('#plot_placeholder').hide();
					//$('#plot_holder').html('');
					$('#plot_holder').css('background-image', 'url('+response['img_url']+')');
					fitPlotDiv();
				}
			});
			*/
		return false; // don't reload the page
	});

});

</script>

{% endblock %}

