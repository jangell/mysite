{% extends "plotbot/layout.html" %}

{% block head_bottom %}
<style>

/* mobile first */

.toolset_title{
	font-family: 'Dosis', sans-serif;
	font-size:1.8rem;
	text-align:center;
	margin:0;
	background-color:#bbb;
	border-bottom:2px solid #aaa;
}
.toolset_content{
	margin:0;
	background-color:#ddd;
}
.tools{
	width:100%;
	border-collapse:collapse;
}
.tool{
	border-bottom:1px solid #aaa;
}
.tool_label{
	padding-left:20px;
	font-weight:bold;
}
.tool_action{
	display:inline-block;
	float:right;
	padding-right:20px;
}


.spec_table_holder{
	margin-top:none;
	margin:20px;
	border:1px solid #888;
	border-radius:5px;
	overflow:hidden;
}
.spec_table{
	width:100%;
	border-collapse:collapse;
	background:white;
}


.spectra_buttons{
	display:flex;
	flex-direction:row;
}
.spec_button{
	flex:1;
	font-size:2rem;
	border:1px solid #888;
	border-radius:5px;
	margin:5px;
	font-family: 'Open Sans', sans-serif;
	cursor:pointer;
	text-align:center;
}
.spec_button:focus{
	outline:none;
}
#remove_spec{
	background-color:#e06b6b;
}
#remove_spec:hover{
	background-color:#e05c5c;
}

#make_plot{
	font-family: 'Dosis', sans-serif;
	font-size:2rem;
	width:calc(100% - 20px);
	margin:10px;
	border-radius:3px;
	background-color:#2c579e;
	color:#eee;
	cursor:pointer;
}
#make_plot:focus{
	outline:none;
}
#make_plot:hover{
	background-color:#1f4077;
}

</style>
<link href="https://fonts.googleapis.com/css?family=Montserrat|Spectral+SC" rel="stylesheet">
{% endblock %}

{% block body %}
{% csrf_token %}
<form id="plot_form">
	<div class="toolset" id="global_tools">
		<h2 class="toolset_title">Global Tools</h2>
		<div class="toolset_content">
			<table class="tools">
				<tr class="tool" id="title">
					<td class="tool_label">Title</td>
					<td class="tool_action">
						<input name="title">
					</td>
				</tr>
				<tr class="tool" id="show_title">
					<td class="tool_label">Show title</td>
					<td class="tool_action">
						<input type=checkbox name="show_title">
					</td>
				</tr>
				<tr class="tool" id="xlabel">
					<td class="tool_label">X-axis label</td>
					<td class="tool_action">
						<input name="xlabel">
					</td>
				</tr>
				<tr class="tool" id="show_xlabel">
					<td class="tool_label">Show x-axis label</td>
					<td class="tool_action">
						<input type=checkbox name="show_xlabel">
					</td>
				</tr>
				<tr class="tool" id="ylabel">
					<td class="tool_label">Y-axis label</td>
					<td class="tool_action">
						<input name="ylabel">
					</td>
				</tr>
				<tr class="tool" id="show_ylabel">
					<td class="tool_label">Show y-axis label</td>
					<td class="tool_action">
						<input type=checkbox name="show_ylabel">
					</td>
				</tr>
				<tr class="tool" id="xmin">
					<td class="tool_label">
						x<sub>min</sub>
					</td>
					<td class="tool_action">
						<input name="xmin" type=number step="any">
					</td>
				</tr>
				<tr class="tool" id="xmax">
					<td class="tool_label">
						x<sub>max</sub>
					</td>
					<td class="tool_action">
						<input name="xmax" type=number step="any">
					</td>
				</tr>
				<tr class="tool" id="ymin">
					<td class="tool_label">
						y<sub>min</sub>
					</td>
					<td class="tool_action">
						<input name="ymin" type=number step="any">
					</td>
				</tr>
				<tr class="tool" id="ymax">
					<td class="tool_label">
						y<sub>max</sub>
					</td>
					<td class="tool_action">
						<input name="ymax" type=number step="any">
					</td>
				</tr>
				<tr class="tool" id="show_legend">
					<td class="tool_label">Show legend</td>
					<td class="tool_action">
						<input type=checkbox name="show_legend">
					</td>
				</tr>
				<tr class="tool" id="legend_location">
					<td class="tool_label">Legend location</td>
					<td class="tool_action">
						<select name="legend_location">
							<option name="top_right">Top right</option>
							<option name="top_left">Top left</option>
							<option name="bottom_left">Bottom left</option>
							<option name="bottom_right">Bottom right</option>
						</select>
					</td>
				</tr>
			</table>
		</div>
	</div>
	<div class="toolset" id="spectra_tools">
		<h2 class="toolset_title">Spectra Tools</h2>
		<div class="toolset_content">
			<!-- list of current spectra -->
			<div class="spec_table_holder">
				<table class="spec_table">
					<thead>
						<tr>
							<th>Name</th>
							<th>Color</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>

			<!-- buttons (add / remove) -->
			<style>
			.fileContainer {
			    overflow: hidden;
			    position: relative;
			}
			.fileContainer [type=file] {
			    cursor: inherit;
			    display: block;
			    opacity:0;
			    min-height: 100%;
			    min-width: 100%;
			    opacity: 0;
			    position: absolute;
			    right: 0;
			    text-align: right;
			    top: 0;
			}
			#add_spec{
				background-color:#87e588;
			}
			#add_spec:hover{
				background-color:#4dd653;
			}
			</style>
			<div class="spectra_buttons">
				<label class="fileContainer spec_button" id="add_spec">
				    Add
				    <input type="file" multiple/>
				</label>

				<button class="spec_button" id="remove_spec">Remove</button>
			</div>

			<!-- tools associated with currently-selected spectrum -->
			<table class="tools">
				<tr class="tool" id="include_in_plot">
					<td class="tool_label">Show</td>
					<td class="tool_action">
						<input name="include_in_plot" type=checkbox>
					</td>
				</tr>
				<tr class="tool" id="include_in_legend">
					<td class="tool_label">Include in legend</td>
					<td class="tool_action">
						<input name="include_in_legend" type=checkbox>
					</td>
				</tr>
				<tr class="tool" id="legend_name">
					<td class="tool_label">Legend name</td>
					<td class="tool_action">
						<input name="legend_name">
					</td>
				</tr>
				<tr class="tool" id="line_width">
					<td class="tool_label">Line width</td>
					<td class="tool_action">
						<input name="line_width" type=number min="0" step="any">
					</td>
				</tr>
				<tr class="tool" id="color">
					<td class="tool_label">Color</td>
					<td class="tool_action">
						<input name="color" type=color value="#7ac7ff">
					</td>
				</tr>
				<tr class="tool" id="opacity">
					<td class="tool_label">Opacity</td>
					<td class="tool_action">
						<input name="opacity" type=number min="0" max="1" step="any">
					</td>
				</tr>
			</table>
		</div>
	</div>
	<button id="make_plot">Plot me up, Scotty!</button>
</form>

<!-- image / plot window (height is set by javascript on update) -->
<style>
#plot_holder{
	border: 5px solid #888;
	height:50vh; /* default */
	display:flex;
	flex-direction:column;
	justify-content:center;
	background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
}
#plot_placeholder{
	text-align:center;
	font-size:2rem;
}
</style>
<div id="plot_holder">
	<div id="plot_placeholder"><p>Nothing yet =(</p></div>
</div>

<script>

// This 


// pass form data as json
$(function() {

	// This takes all settings and passes it over to the server, and then updates the plot holder with the image url returned by the server
	$('#plot_form').submit(function() {
		var form_data = $('#plot_form').serializeArray();
		to_json = {};
		for(var i = 0; i < form_data.length; i++)
			to_json[form_data[i]['name']] = form_data[i]['value'];
			string_data = JSON.stringify(to_json);
			// ajax the stringified data

			// TODO: "loading" gif while waiting for plot to process

			$.get({
				url:'make_plot',
				data:to_json,
				success:function(response){
					$('#plot_holder').html('');
					$('#plot_holder').css('background-image', 'url('+response['img_url']+')');
					fitPlotDiv();
				}
			});
		return false; // don't reload the page
	});

	// This handles uploading 1+ new spectra. It is also garbage
	/*
	$('#add_spec [type=file]').on('change',function(){
		// loop through files and add to FormData object
		// FUTURE: keep a list of hashes of all available spectra, and don't bother re-uploading if the spectra is already in the database (that checking will get build in this time as well, but only server-side; going client-side with hashes will make it faster)
		var formData = new FormData();
		for(var i = 0; i < this.files.length; i++){
			var curFile = this.files[i];
			formData.append('spectra',curFile);
		}
		// set up XMLHttpRequest to transfer files to server
		var xhr = new XMLHttpRequest();
		xhr.open('POST', 'upload_spec', true);

		// Set up a handler for when the request finishes.
		xhr.onload = function () {
		  if (xhr.status === 200) {
		    // File(s) uploaded.
		    console.log('File(s) uploaded!')
		  } else {
		    alert('An error occurred =(');
		  }
		};

		// Send the Data.
		xhr.send(formData);

	});
	*/

	// This adds a new set of SpecConfig settings (for cleanliness, settings are handled entirely in HTML until it's time to transfer them to the server)

	// This removes a spectrum from the working set, including removing its SpecConfig

});
// re-fit the plot div when the window is resized
$(window).on('resize',function(){
	fitPlotDiv();
});

// scales the height of the plot div so that it exactly fits the original plot dimensions with a fixed width
function fitPlotDiv(){
	var shown_width = $('#plot_holder').width();
	var img = new Image();
	img.src = $('#plot_holder').css('background-image').replace(/url\(|\)$|"/ig, '');
	$(img).on('load',function(){
		var shown_width = $('#plot_holder').width();
		var to_h = shown_width * img.height / img.width;
		$('#plot_holder').height(to_h);
	});
}
</script>

{% endblock %}

