{% extends "plotbot/layout.html" %}
{% load static %}

{% block head_bottom %}

<title>PlotBot | Spectral plotting</title>
<!-- plotly cdn -->
<!-- TODO: move these onsite -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script> <!-- for autocomplete -->

<script src="https://cdn.jsdelivr.net/npm/vue"></script> <!-- vue.js -->

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> <!-- autocomplete css -->
<link rel="stylesheet" href="{% static 'plotbot/css/index.css' %}"> <!-- all of the custom page styling -->
<link href="https://fonts.googleapis.com/css?family=Montserrat|Spectral+SC" rel="stylesheet"> <!-- google fonts cdn for our page fonts -->

{% endblock %}

{% block body %}
{% csrf_token %}



<!-- modal -->
<div class="modal_bg">
	<script>
	// hide modal on page load (not the long-term solution) (actually, for now, it is)
	$('.modal_bg').hide();
	</script>
	<div class="modal">
		<h2 class="modal_title">Add Spectrum</h2>
		<div class="modal_content">
			<div class="tabs">
				<div class="tab selected_tab" id="csv_tab">
					<h3 class="modal_subtitle" title="Use for files on your computer">Upload from CSV</h3>
				</div>
				<div class="tab" id="db_tab">
					<h3 class="modal_subtitle" title="Use to add mineral spectra from the database">Add from database</h3>
				</div>
				<button id="cancel_modal" title="Return to plotting window">Cancel</button>
			</div>
			<div class="modal_option" id="modal_csv">
				<!-- add by uploading csv -->
				<form id="modal_form">
					<input name=file type=file accept=".csv" id="spec_upload_file">
					<hr>
					<table>
						<tr>
							<td>Name</td>
							<td><input id="modal_spec_name" name=name></td>
						</tr>
					</table>
					<hr>
					<input type=submit value="Upload">
				</form>
			</div>
			<div class="modal_option" id="modal_db">
				<!-- search by name -->
				<!-- filter by wavelength -->
				<div class="db_filters">
					<div class="filter wv_filter">
						<label for="wv_select" title="Only show spectra with selected wavelength">Filter by wavelength</label>
						<select id="wv_select">
							<option value="all">All</option>
							{% for wv in wavelengths %}
							<option value="{{wv.wavelength}}nm">{{wv.wavelength}}nm</option>
							{% endfor %}
						</select>
					</div>
					<div class="filter name_filter">
						<label for="name_select" title="Show minerals whose name contains the search string">Filter by name</label>
						<input id="name_select">
					</div>
				</div>
				<!-- adding from database - list all database options (for now, in one list) -->
				<div class="db_table_holder">
					<div id="filter_loading">
						<img src="{% static 'plotbot/img/loading.gif' %}">
					</div>
					<table class="database_table">
						<thead id="modal_db_thead">
							<tr class="modal_db_headrow">
								<th class="modal_db_id" title="ID number">ID</th>
								<th class="modal_db_name" title="Mineral name">Name</th>
								<th class="modal_db_source" title="Source of data">Source</th>
								<th class="modal_db_wv" title="Excitation wavelength (nm)">Wavelength</th>
							</tr>
						</thead>
						<tbody id="modal_db_tbody">
							<!-- database spectra get filled in here -->
						</tbody>
					</table>
				</div>
			</div>
			<!-- end of options -->
		</div>
	</div>
</div>

<style>
.all_tools{
	display:flex;
	flex-direction:row;
	flex-wrap:wrap;
}
.tools_table{
	width:100%;
	border-collapse:collapse;
}
.flex_tool{
	display: flex;
	flex-direction: row;
	justify-content: space-between;
}
.mini_number{
	width:50px;
}
.tool_label{
	white-space:nowrap;
	padding-left:10px;
}
.right{
	float:right;
	padding-right:10px;
}
label{
	white-space: nowrap;
}
</style>

<form id="plot_form">
	<div class="all_tools">
		<div class="toolset" id="global_tools" style="border-left:none;">
			<h2 class="toolset_title" title="Settings that affect the plot as a whole">Plot Options</h2>

			<div class="toolset_content">
				<!-- each list of tools is gonna be a table, aiight? -->
				<table class="tools_table">
					<tr>
						<td><label class="tool_label" for="title_target">Title</label></td>
						<td class="right"><input class="tool" id="title_target" placeholder='No title' title='Title displayed on plot'></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="xlabel_target">X Label</label></td>
						<td class="right"><input class="tool" id="xlabel_target" value="Wavenumber (cm<sup>-1</sup>)" title="Label on x axis of plot"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="ylabel_target">Y Label</label></td>
						<td class="right"><input class="tool" id="ylabel_target" value="Intensity" title="Label on y axis of plot"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="x_range">X Range</label></td>
						<td class="right">
							<div id="x_range" class="flex_tool">
								<input type=number step=any class="mini_number" id="xmin_target" placeholder="Auto" title="Minimum value of x axis">
								<span> - </span>
								<input type=number step=any class="mini_number" id="xmax_target" placeholder="Auto" title="Maximum value of x axis">
							</div>
						</td>
					</tr>
					<tr>
						<td><label class="tool_label" for="y_range">Y Range</label></td>
						<td class="right">
							<div id="y_range" class="flex_tool">
								<input type=number step=any class="mini_number" id="ymin_target" placeholder="Auto" title="Minimum value of y axis">
								<span> - </span>
								<input type=number step=any class="mini_number" id="ymax_target" placeholder="Auto" title="Maximum value of y axis">
							</div>
						</td>
					</tr>
					<tr>
						<td><label class="tool_label" for="showlegend_target">Legend</label></td>
						<td class="right"><input type=checkbox id="showlegend_target" checked title="Show / hide legend"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="showgrid_target">Grid</label></td>
						<td class="right"><input type=checkbox id="showgrid_target" checked title="Show / hide grid"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="showticks_target">Ticks</label></td>
						<td class="right"><input type=checkbox id="showticks_target" title="Show / hide ticks"></td>
					</tr>
				</table>
			</div>
			<!--
				plot config target
			<div id="pc_target" class="toolset_content"></div>
			-->

			<!--
				vertical line target
			<div id="vl_target" class="toolset_content"></div>
			-->
		</div>

		<!--
		<div class="toolset" id="spec_info">
			<h2 class="toolset_title" title="More info about the spectrum, if available">Spec Info</h2>
			<div class="toolset_content">
				More to come here...
			</div>
		</div>
		-->

		<div class="toolset" id="spectra_tools">
			<h2 class="toolset_title" title="Settings that affect only the selected spectrum">Spec Options</h2>
			<div class="toolset_content">
				<table class="tools_table">
					<tr>
						<td><label class="tool_label" for="show_target">Show</label></td>
						<td class="right"><input type=checkbox id="show_target" checked></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="label_target">Label</label></td>
						<td class="right"><input id="label_target"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="linewidth_target">Line Width</label></td>
						<td class="right"><input type=number step=any min=0.1 id="linewidth_target"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="color_target">Color</label></td>
						<td class="right"><input type=color id="color_target"></td>
					</tr>
					<tr>
						<td><label class="tool_label" for="opacity_target">Opacity</label></td>
						<td class="right"><input type=number step=any min=0 max=1 id="opacity_target"></td>
					</tr>
					<tr><td>Preprocessing...<td></tr>
				</table>

				<!--
				<div class="spec_table_holder">
					<table class="spec_table">
						<thead class="spec_table_head">
							<tr>
								<th class="spec_row_name" title="Name of spectrum">Name</th>
								<th class="spec_row_color" title="Color of plotted line">Color</th>
								<th class="spec_row_show" title="Whether spectrum is shown in plot">Showing</th>
							</tr>
						</thead>

						<tbody class="spec_table_body" id="sl_target">
						</tbody>

					</table>
				</div>

				<div id="sc_target">

				</div>
				-->

			</div>
		</div>

		<!--
		<div class="toolset" id="annotation_tools">
			<h2 class="toolset_title">Annotations</h2>
			<div class="toolset_content">

			</div>
		</div>
	-->

		<style>
		.table_wrapper{
			margin:5px;
			background-color: #f8f8f8;
			flex:1;
			overflow-y: scroll;
			max-height:15vh;
		}
		.lines_table{
			border-collapse: collapse;
		}
		.toolset_row{
			display:flex;
			flex-direction:row;

		}
		.toolset_row_item{
			flex:1;
			margin:5px;
		}
		.button_spacer{
			padding: 2px 7px 1px 7px;
		}
		#savepng_target{
		}
		</style>

		<div class="toolset" id="spec_list">
			<h2 class="toolset_title">Spectra</h2>
			<div class="toolset_content">
				<!-- table to store the currently-showing spectra -->
				<!-- .showing is regular, .not_showing is greyed out (or greyed over, including color patch?) -->
				<div class="table_wrapper">
					<table class="lines_table">
						<tbody id="speclist_target">
						</tbody>
					</table>
				</div>

				<!-- buttons to add & remove from table -->
				<div class="toolset_row">
					<button type=button class="toolset_row_item" id="add_button">Add Spec</button>
					<button type=button class="toolset_row_item" id="remove_button">Remove Spec</button>
				</div>

				<!-- quick-add -->
				<div class="toolset_row">
					<label class="toolset_row_item" for="quickadd_target">Quick Add</label>
					<input class="toolset_row_item" id="quickadd_target">
				</div>

				<!-- save png button (TODO: make that thang hi-res homie!) -->
				<div class="toolset_row">
					<span class="toolset_row_item button_spacer"></span>
					<button type=button class="toolset_row_item" id="savepng_target">Save PNG</button>
				</div>

			</div>
		</div>

	</div>
</form>

<div class="toolset" id="plot_holder">

</div>

<script src="{% static 'plotbot/js/plot_spec.js' %}"></script> <!-- main script with classes and everything for this all to work -->

<script>

/* new plot page actions:
	- generate plot config html and insert into correct point in page
	- generate spec list html and insert into correct point in page
	- generate any spec config html and insert into correct point (hide all but one)
*/

var ph = new PlotHandler($('#plot_holder'));
ph.initialize();

// stop <input type=number> from changing on scroll
$(document).on("wheel", "input[type=number]", function (e) {
    $(this).blur();
});

// block scrolling full page when scrolling spec list
/*
var speclist = $('#speclist_target'),
  height = speclist.height(),
  scrollHeight = speclist.get(0).scrollHeight;

speclist.bind('mousewheel', function(e, d) {
if((this.scrollTop === (scrollHeight - height) && d < 0) || (this.scrollTop === 0 && d > 0)) {
  e.preventDefault();
}
});
*/
$('#speclist_target').bind('mousewheel', function(e){

});

// modal window

// make the 'cancel' button in modal close the modal
$('#cancel_modal').click(function(){
	clearModal();
	$('.modal_bg').hide();
});

// set the default name to the file name when one is selected
$('#spec_upload_file').change(function(){
	var filename = $('#spec_upload_file').val().split('\\').reverse()[0];
	var specname = filename.slice(0,-4);
	$('#modal_spec_name').attr('value',specname);
});

// clear data from modal
function clearModal(){
	var modal = $('.modal');
	modal.find('#modal_spec_name').val('');
	modal.find('#spec_upload_file').val('');
}

// handle modal form submission
// parse csv, including checking that the domain is in output[0] and ordered low to high
$('#modal_form').submit(function(event){
	event.preventDefault(); // don't reload the page on form submit
	// parse the data in a filereader (it's async and it's reeeeal ugly)
	var wavs, counts;
	var lista = [];
	var listb = [];
	var reader = new FileReader;
	reader.onload = function(){
		// parse into lists
		var data = reader.result.split(/\r|\n/); // this regex is to make sure we don't run into the windows vs mac newline issue
		for(var i = 0; i < data.length; i++){
			try{
				var points = data[i].split(',');
				var to_a = parseFloat(points[0]);
				var to_b = parseFloat(points[1]);
				if(to_a && to_b){
					lista.push(to_a);
					listb.push(to_b);
				}
			}
			catch(err){
				console.log(err);
				console.log('skipped line: '+data[i]);
			}
		}
		// find the one that's going up or down by a consistent amount (assume it's the one where the point in the middle is closest to halfway between the start and end values. there's a very small chance this is wrong. TODO: fix this issue)
		// span is the difference between the first and last values
		var lista_span = lista[lista.length - 1] - lista[0]
		var listb_span = listb[listb.length - 1] - listb[0]
		// mid is the value in the middle
		var lista_mid = lista[lista.length / 2]
		var listb_mid = listb[listb.length / 2]
		// gap is the difference between the mid and half the span
		var lista_gap = Math.abs(lista_mid - (lista[0] + (lista_span/2)));
		var listb_gap = Math.abs(listb_mid - (listb[0] + (listb_span/2)));
		// the smaller gap is the wavenumbers
		if(lista_gap < listb_gap){
			wavs = lista;
			counts = listb;
		}
		else{
			wavs = listb;
			counts = lista;
		}
		// check if wavs (and therefore both) need reversing
		if(wavs[1] < wavs[0]){
			wavs.reverse();
			counts.reverse();
		}
		data = [wavs,counts];
		// get name input and then send it to the plothandler

		var specname = $('#modal_spec_name').val();
		ph.addSpec(specname, data);
		clearModal();
		$('.modal_bg').hide();
	}
	var file = document.querySelector('#spec_upload_file').files[0];
	reader.readAsText(file);
});

// returns a jquery html row, given a name and wavelength
function modalDbRow(id, name, source, wv){
	var wv_str;
	var src_str;
	var row = $('<tr>').addClass('modal_db_row');
	row.append($('<td>').addClass('modal_db_id').html(id));
	row.append($('<td>').addClass('modal_db_name').html(name));
	if(source != null){
		src_str = source;
	}
	else{
		src_str = 'Unknown';
	}
	row.append($('<td>').addClass('modal_db_source').html(src_str));
	if(wv != -1){
		wv_str = wv+'nm';
	}
	else{
		wv_str = 'Unknown';
	}
	row.append($('<td>').addClass('modal_db_wv').html(wv_str));
	return row;
}

$('.tab').click(function(){
	// set this tab class
	$('.selected_tab').removeClass('selected_tab');
	$(this).addClass('selected_tab');
	// set the correct modal_option
	$('.modal_option').hide();
	if($(this).attr('id') == 'csv_tab'){
		$('#modal_csv').show();
	}
	else{
		$('#modal_db').show();
	}
});

$(document).ready(function(){
	// load database into modal_db_tbody at page load (for now)
	{% for spec in specs %}
	$('#modal_db_tbody').append(modalDbRow('{{spec.spec_id}}', '{{spec.name}}', '{{spec.source}}', '{{spec.wavelength}}'));
	quick_add_list.push({'label':'{{spec.name}} - {{spec.wavelength}}nm','value':'{{spec.spec_id}}'});
	{% endfor %}
	// this has to go to the end because it's going to tie into plothandler and all those rows
	$('.modal_db_row').click(function(){
		var id = $(this).find('.modal_db_id').html();
		console.log(id);
		ph.addSpecByDbId(id);
		$('.modal_bg').hide();
		// add spectrum to plothandler
	});

	function updateFilters(){

		// show 'loading' gif

		var wv = $('#wv_select').val();
		var str = $('#name_select').val().toLowerCase();

		if(wv == 'all'){
			// show all wavelengths
			$('.modal_db_row').show();
			// then filter by name
			$('.modal_db_row').each(function(){
				if($(this).find('.modal_db_name').html().toLowerCase().match(str)){
					$(this).show();
				}
				else{
					$(this).hide();
				}
			});
		}
		else{
			$('.modal_db_row').each(function(){
				if($(this).find('.modal_db_wv').html() != wv){
					$(this).hide();
				}
				else{
					// this is where filter-by-name comes in
					if($(this).find('.modal_db_name').html().toLowerCase().match(str)){
						$(this).show();
					}
					else{
						$(this).hide();
					}
				}
			});
		}
		// hide 'loading' gif

	}
	// wavelength filter
	$('#wv_select').change(function(){
		updateFilters();
	});
	$('#name_select').on('input',function(){
		updateFilters();
	});

});


// testing ground for new code

/*
$('#plot_holder').on('plotly_relayout',function(e){
	console.log('yo!');
	debugger;
});
*/

// nothing below here matters if we're doing plotly (except for saving state sometime in the future)

// pass form data as json
$(function() {

	// This takes all settings and passes it over to the server, and then updates the plot holder with the image url returned by the server
	$('#plot_form').submit(function() {
		// bail!
		return false;
		var form_data = $('#plot_form').serializeArray();
		to_json = {};
		for(var i = 0; i < form_data.length; i++)
			to_json[form_data[i]['name']] = form_data[i]['value'];
			string_data = JSON.stringify(to_json);
			// ajax the stringified data

			//$('#plot_placeholder').show();
			/*
			$.get({
				url:'make_plot',
				data:to_json,
				success:function(response){
					$('#plot_placeholder').hide();
					//$('#plot_holder').html('');
					$('#plot_holder').css('background-image', 'url('+response['img_url']+')');
					fitPlotDiv();
				}
			});
			*/
		//return false; // don't reload the page
	});

});

</script>

{% endblock %}

