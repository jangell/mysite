{% extends "plotbot/layout.html" %}
{% load static %}

{% block head_bottom %}

<!-- plotly cdn -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
 <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script> <!-- for autocomplete -->
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.3.6/papaparse.min.js"></script> papaparse -->
<script>
// TO BE MOVED TO: plot_spec_configs.js
// Jason Angell
// SETI Institute / NASA Ames Research Center
// 9 December 2017

// define javascript classes for PlotConfig and SpecConfig objects

var valid_inputs = ['checkbox','text','number','color','button'];
var quick_add_list = [];

function randomHex(){
	var hexVal = (parseInt(Math.random() * 256)).toString(16);
	return ('0'+hexVal).slice(-2);
}

function randomColor(){
	var r, g, b;
	r = randomHex();
	g = randomHex();
	b = randomHex();
	return '#'+r+g+b;
}

// one field of a config (like figure width, or line color)
class Field{
	constructor(ident,label,input,defaults={}){
		// default input type is text
		if(valid_inputs.indexOf(input) == -1){input = 'text';}
		this.identifier = ident;
		this.label = label;
		this.input = input;
		if(typeof(defaults) === 'undefined'){
			this.defaults = null;
		}
		else{
			this.defaults = defaults;
		}
		this.element = null; // this is where the value in the element gets wired into the field itself (to be accessed by the specconfig via getValue() )
	}
	// gets the value from the current element that this field has generated
	getValue(){
		if(this.element){
			if(this.input == 'checkbox')
				return this.element.is(':checked');
			return this.element.val();
		}
		return null;
	}
	
	//
	updateValue(){
		alert('value of '+this.label+'is '+self.getValue());
	}

	// generates html to represent this field as a table row
	toTableRow(){
		// return the field as a table row
		var container = $('<tr>');
		container.addClass('tool');
		container.attr('id', this.identifier); // identifier is id of row and name of input
		container.append($('<td>').addClass('tool_label').html(this.label));
		var inputter = $('<input>').attr('type',this.input).attr('name',this.identifier);
		
		// wire in the moving parts
		this.element = inputter;
		
		// number inputter should have a step of any
		if(this.input == 'number'){inputter.attr('step','any');}

		// set the defaults based on the dictionary passed in
		for(var key in this.defaults){
			inputter.attr(key,this.defaults[key]);
		}

		var action = $('<td>').addClass('tool_action').append(inputter);
		container.append(action);
		return container;
	}
}

// SpecConfig (reminder: classes are not hoisted in js)
class SpecConfig{
	constructor(spec_id, spec_name, spec_data){
		this.spec_id = spec_id; // unique identifier to keep track of which spectra are which when we modify things later on
		this.spec_name = spec_name;
		this.spec_data = spec_data;
		this.selected = false; // keep track of which is currently showing (and highlighted)
		this.fields = {};
		this.fields['show'] = new Field('spec'+this.spec_id+'_show', 'Show', 'checkbox', {'checked':true});
		this.fields['legend_name'] = new Field('spec'+this.spec_id+'_legend_name', 'Legend label', 'text',{'value':this.spec_name,'placeholder':'No label'});
		this.fields['line_width'] = new Field('spec'+this.spec_id+'_line_width', 'Line width (px)', 'number', {'value':2});
		this.fields['color'] = new Field('spec'+this.spec_id+'_color', 'Color', 'color', {'value':randomColor()});
		this.fields['opacity'] = new Field('spec'+this.spec_id+'_opacity', 'Opacity', 'number', {'value':1});
		// this.last_data = this.spec_data;
		// this.has_changed = false;
	}

	valueOf(field){
		return this.fields[field].getValue();
	}

	// returns the id to use for the relevant row in the speclist
	getRowId(){
		return 'speclist_'+this.spec_id;
	}
	getRowSelector(){
		return '#'+this.getRowId();
	}
	// returns the id to use for the relevant div in the specconfig
	getConfigId(){
		return 'specconfig_'+this.spec_id;
	}
	getConfigSelector(){
		return '#'+this.getConfigId();
	}

	// generates a row with name and show/don't-show checkbox
	generateSpecListHtml(){
		var _this = this; // we map the class 'this' to '_this' so that we can reference it in the function below, where 'this' refers to the jquery object
		// javascript is dumb. jquery is dumb. programming is stupid.

		// create the actual row
		var row = $('<tr>').addClass('spec_table_row').attr('id',this.getRowId());
		// add entry for spec name
		row.append($('<td>').addClass('spec_row_name').html(this.spec_name));
		// add entry for spec color
		var color_box = $('<td>').addClass('color_box').addClass('spec_row_color');
		row.append(color_box);
		// add entry for showing box
		var show_box = $('<input>').attr('type','checkbox').attr('checked',true).attr('disabled',true);
		var to_add = $('<td>').addClass('spec_row_show').append(show_box);
		row.append(to_add);

		// set css based on whether this is selected or not
		if(this.selected){row.addClass('selected_row');}
		else{row.addClass('unselected_row');}

		// get the html id of the config table and the speclist row (we need them for the functions)
		var configId = this.getConfigSelector();
		var rowId = this.getRowSelector();

		// function for when this spec is clicked on in the list
		row.on('click',function(){
			// hide all
			$('.showing_config').hide();
			$('.showing_config').removeClass('showing_config').addClass('hidden_config');
			// show the one that was clicked
			$(configId).show();
			$(configId).removeClass('hidden_config').addClass('showing_config');
			// unselect all rows
			$('.selected_row').removeClass('selected_row').addClass('unselected_row');
			// select this one
			$(rowId).removeClass('unselected_row').addClass('selected_row');
		});

		// not allowing 'showing' checkbox to be clickable at the moment (weird bugs)
		/*
		// function for when this spec's 'show' checkbox is clicked on
		show_box.click(function(){
			var checked = show_box.is(':checked');	// get whether or not it's checked
			// TODO: show or hide in plot (tbd)
			_this.fields['show'].element.attr('checked',checked);	// update the show box in the relevant config
		});
		*/

		return row;
	}

	// get the current color of the spec config as rgba string
	getColor(){
		var r, g, b, a;
		var hex = this.valueOf('color'); // always gets a hex string (ex., #rrggbb)
		a = this.valueOf('opacity');
		r = parseInt(hex.substring(1,3), 16);
		g = parseInt(hex.substring(3,5), 16);
		b = parseInt(hex.substring(5,7), 16);
		return 'rgba('+r+','+g+','+b+','+a+')';
	}

	// update the background color of the spec list based on the color & opacity of the 
	updateColor(){
		var _this = this;
		var rowId = this.getRowSelector();
		$(rowId).find('.color_box').css('background-color',_this.getColor());
	}

	// generates an html table for spec configuration
	generateSpecConfigHtml(){
		var _this = this; // see complaint in generateSpecListHtml()
		// get the html id of the config table and the speclist row (we need them for the functions)
		var configId = this.getConfigSelector();
		var rowId = this.getRowSelector();

		var table = $('<table>').addClass('tools');
		table.attr('id',this.getConfigId());

		if(this.selected){
			table.addClass('showing_config');
		}
		else{
			table.addClass('hidden_config');
		}

		for(var field in this.fields){
			table.append(this.fields[field].toTableRow(self.spec_id));
		}

		// function to update the 'show' checkbox in spec list based on a change in the one in the spec config table
		this.fields['show'].element.change(function(){
			var checked = _this.valueOf('show');
			$(rowId).find('input').attr('checked',checked);
		});
		
		// function to update the 'color' box in spec list based on a change to color or opacity in spec config
		this.fields['color'].element.change(function(){
			_this.updateColor();
		});
		this.fields['opacity'].element.change(function(){
			_this.updateColor();
		});
		_this.updateColor();
		return table;

	}

	// returns a plotly-friendly data object
	getPlotlyData(){
		// check here if 'show' is true or not (if not, return null immediately)
		if(!this.valueOf('show')){return null;}
		return {
			x: this.spec_data[0],
			y: this.spec_data[1],
			name: this.valueOf('legend_name'),
			showlegend: !(this.valueOf('legend_name') == ''), // only show in legend if field isn't blank
			line: {
				color: this.getColor(), // color and opacity (convert to rgba)
				width: this.valueOf('line_width'), // line width in pixels
			}
		}
	}

}

// PlotConfig
class PlotConfig{
	constructor(){
		// set values to defaults
		this.fields = {};
		//this.fields['fig_width'] = new Field('fig_width', 'Width', 'number');
		//this.fields['fig_height'] = new Field('fig_height', 'Height', 'number');
		this.fields['title'] = new Field('title', 'Title', 'text', {'placeholder':'No title'});
		//this.fields['show_title'] = new Field('show_title', 'Show title', 'checkbox');
		this.fields['xlabel'] = new Field('xlabel', 'X-axis label', 'text', {'value': 'Wavenumber'});
		this.fields['ylabel'] = new Field('ylabel', 'Y-axis label', 'text', {'value': 'Intensity'});
		this.fields['xmin'] = new Field('xmin', 'x<sub>min</sub>', 'number', {'placeholder':'Auto'}); // doesn't do anything yet
		this.fields['xmax'] = new Field('xmax', 'x<sub>max</sub>', 'number', {'placeholder':'Auto'}); // doesn't do anything yet
		this.fields['ymin'] = new Field('ymin', 'y<sub>min</sub>', 'number', {'placeholder':'Auto'}); // doesn't do anything yet
		this.fields['ymax'] = new Field('ymax', 'y<sub>max</sub>', 'number', {'placeholder':'Auto'}); // doesn't do anything yet
		this.fields['show_legend'] = new Field('show_legend', 'Show legend', 'checkbox', {'checked':'true'});
		this.fields['quick_add'] = new Field('quick_add', 'Quick add from database', 'text');
		this.fields['add_spec'] = new Field('add_spec', 'Add spectrum', 'button', {'value':'Add'});
		this.fields['remove_spec'] = new Field('remove_spec', 'Remove selected spectrum', 'button', {'value':'Remove'});
		// TODO: create legend location
		//this.legend_location = new Field('legend_location', 'Legend location', 'option', {'0':'Top right', '1':'Top left', '2':'Bottom left', '3':'Bottom right'});
	}

	// convert fields to html table
	toTable(){
		var table = $('<table>').addClass('tools');
		for(var field in this.fields){
			table.append(this.fields[field].toTableRow());
		}
		return table;
	}

	// returns the value of a field
	valueOf(field){
		return this.fields[field].getValue();
	}
}

// handler for plot config and all spec configs for a given page
class PlotHandler{
	constructor(plot_config_target, spec_list_target, spec_config_target, plot_target){
		this.plot_config_target = plot_config_target;
		this.spec_list_target = spec_list_target;
		this.spec_config_target = spec_config_target;
		this.plot_target = plot_target;

		this.cur_spec_id = 0; // use this as spec ids as you go, to make sure they're identifiable
		this.plotConfig = new PlotConfig();
		this.specConfigList = [];
	}

	// get the index of a spectrum in specConfigList based on its spec id
	getSpecIndexById(id){
		for(var i = 0; i < this.specConfigList.length; i++){
			if(this.specConfigList[i].spec_id == id){
				return i;
			}
		}
		return -1;
	}

	getSelectedSpecIndex(){
		var _this = this;
		if($('.selected_row').length){
			var selected_spec_id = $('.selected_row').attr('id').split('_')[1];
			var ssi = _this.getSpecIndexById(selected_spec_id);
			return ssi;
		}
		else{
			return null;
		}
	}

	// appends the plot config html to the jquery element <target>
	// creates a handler for any changes to tools to redraw the plot
	insertPlotConfigHtml(){
		this.plot_config_target.append(this.plotConfig.toTable());
	}

	// inserts the spec list html at the end of the current spec list
	appendSpecListRow(specConfig){
		this.spec_list_target.append(specConfig.generateSpecListHtml());
	}

	appendSpecConfigHtml(specConfig){
		// show the first one, but hide all the others
		this.spec_config_target.append(specConfig.generateSpecConfigHtml());
	}

	// adds a spectrum based on its database id
	addSpecByDbId(id){
		var _this = this;
		// ajax call to get db spectrum with id in modal_db_id
		$.get({
			url:'getSpec',
			data:{'spec_id':id},
			success:function(response){
				_this.addSpec(response['name'],response['data'])
				return true;
			}
		});
	}

	// adds a spectrum to the working set
	addSpec(spec_name, spec_data){
		var _this = this;
		var sc = new SpecConfig(this.cur_spec_id, spec_name, spec_data);
		this.cur_spec_id++; // make sure each is unique
		// append it to spec config list
		this.specConfigList.push(sc);
		// if it's the only specconfig, show & select it
		if(this.specConfigList.length == 1){
			sc.selected = true;
		}
		// add row to speclist
		this.appendSpecListRow(sc);
		// add div to specConfigs
		this.appendSpecConfigHtml(sc);
		// add event listeners to new tools
		this.addToolListeners();
		// select the newly added plot (hint: it's the last one)
		$(this.specConfigList[this.specConfigList.length-1].getRowSelector()).click();
		// redraw the plot
		this.updatePlot();
	}

	// updates the plot drawing
	updatePlot(){
		var _this = this;
		var id = this.plot_target.attr('id');
		var plot_div = document.getElementById(id);

		// spectral data -> list of data
		var data = [];
		for(var i = 0; i < this.specConfigList.length; i++){
			var cur_data = this.specConfigList[i].getPlotlyData();
			// if <show> is false, this will return null, so we'll skip it
			if(cur_data != null){
				data.push(cur_data);
			}
		}

		// global variables -> layout
		var layout = {
			// margin is arbitrary for now
			margin: {
				l: 70,
				r: 40,
				t: 60,
				b: 80
			},
			title: this.plotConfig.valueOf('title'),
			titlefont: {
				size: 22,
			},
			// x axis dictionary (expand to advanced features later)
			xaxis: {
				title: this.plotConfig.valueOf('xlabel'),
				titlefont: {
					size: 16,
				},
				range: [parseFloat(this.plotConfig.valueOf('xmin')),parseFloat(this.plotConfig.valueOf('xmax'))]
			},
			yaxis: {
				title: this.plotConfig.valueOf('ylabel'),
				titlefont: {
					size: 16,
				},
				range: [parseFloat(this.plotConfig.valueOf('ymin')),parseFloat(this.plotConfig.valueOf('ymax'))]
			},
			showlegend: this.plotConfig.valueOf('show_legend'),

		}

		Plotly.newPlot(plot_div, data, layout, {showLink:false});

		// hook in a function to update settings on zoom / pan
		plot_div.on('plotly_relayout',function(eventdata){
			var nDigits = 2;
			// eventdata is either dragmode, autorange, or x-/y-axis ranges
			var pc = _this.plotConfig;
			if(eventdata['dragmode']){
				// do nothing
				return;
			}
			// implied <else if>, because if the last one was true, it returns and never gets here
			// for autorange, reset plotting range in form
			if(eventdata['xaxis.autorange']){
				pc.fields['xmin'].element.val('');
				pc.fields['xmax'].element.val('');
			}
			if(eventdata['yaxis.autorange']){
				pc.fields['ymin'].element.val('');
				pc.fields['ymax'].element.val('');
			}
			// this just gives us the whole range, no questions asked! What a great day!
			if(eventdata['xaxis.range[0]']){pc.fields['xmin'].element.val(eventdata['xaxis.range[0]'].toFixed(nDigits));} // yes, the whole thing is the key. no, i don't get it either
			if(eventdata['xaxis.range[1]']){pc.fields['xmax'].element.val(eventdata['xaxis.range[1]'].toFixed(nDigits));}
			if(eventdata['yaxis.range[0]']){pc.fields['ymin'].element.val(eventdata['yaxis.range[0]'].toFixed(nDigits));}
			if(eventdata['yaxis.range[1]']){pc.fields['ymax'].element.val(eventdata['yaxis.range[1]'].toFixed(nDigits));}
		});

		// hook in a resize function
		$(window).on('resize',function(){
			Plotly.Plots.resize(plot_div);
		});
	}

	// adds an event listener to all .tool changes to update the plot
	addToolListeners(){
		var _this = this;
		this.updatePlot();
		$('.tool').change(function(){
			_this.updatePlot();
		});
	}

	
	// shows a modal window, handles getting the spectrum from it
	showAddModal(){
		$('.modal_bg').show();
		// add a handler to the escape key to get rid of modal
		$(document).keydown(function(e){
			if(e.keyCode == 27){
				$('.modal_bg').hide();
			}
		});
	}

	
	// adds event listeners to the add and remove buttons
	startAddRemove(){
		var _this = this;
		// add spectrum
		_this.plotConfig.fields['add_spec'].element.click(function(){
			_this.showAddModal();
		});

		// quick add from db (autofill on quick_add)
		$(_this.plotConfig.fields['quick_add'].element).autocomplete({
			source: quick_add_list,
			select: function(event, ui){
				$(_this.plotConfig.fields['quick_add'].element).val(ui.item.label);
				var selected = ui.item.value;
				_this.addSpecByDbId(selected); // oh my god this is so cool and so easy
				return false;
			}
		})

		// remove spectrum
		_this.plotConfig.fields['remove_spec'].element.click(function(){
			// get which spectrum is currently selected
			var selected_spec_index = _this.getSelectedSpecIndex();
			// make sure it exists
			if(selected_spec_index < 0){
				console.log('attempted to remove spectrum that could not be found');
				return false;
			}
			// get specConfig object
			var sc = _this.specConfigList[selected_spec_index];
			// remove html config
			$(sc.getConfigSelector()).remove();
			// remove html row
			$(sc.getRowSelector()).remove();
			// remove specConfig object
			if(selected_spec_index > -1){
				_this.specConfigList.splice(selected_spec_index,1);
				_this.updatePlot();
			}
			// select next spec if it exists (just "click" on its row)
			// try the index of the list we just deleted
			if(_this.specConfigList.length > selected_spec_index){
				$(_this.specConfigList[selected_spec_index].getRowSelector()).click();
			}
			// if that fails, try index 0
			else if(_this.specConfigList.length > 0){
				$(_this.specConfigList[0].getRowSelector()).click();
			}
			// so now we selected something valid the list is empty. ok. cool.
			return true;
		});
	}
	
	// add key commands (up and down arrow) for navigating spec list
	// up: 38
	// down: 40
	startArrowShortcuts(){
		var _this = this;
		$(document).keydown(function(e){
			var ssi = _this.getSelectedSpecIndex();
			if(e.keyCode == 38){
				if(ssi != null && ssi > 0){
					$(ph.specConfigList[ssi-1].getRowSelector()).click();
					e.preventDefault();
				}
			}
			else if(e.keyCode == 40){
				if(ssi != null && ssi < (_this.specConfigList.length - 1)){
					$(ph.specConfigList[ssi+1].getRowSelector()).click();
					e.preventDefault();
				}
			}
		});
	}

	initialize(){
		// insert plot configuration html
		this.insertPlotConfigHtml();
		// add event listeners for plot updates
		this.addToolListeners();
		// add event listeners to add & remove spectra and key commands
		this.startAddRemove();
		this.startArrowShortcuts();

		this.updatePlot();
	}

}

</script>

<style>

	/* mobile first */
	/* TO BE MOVED TO: index.css */
	html{
		background:#cce;
	}

	.toolset{
		background-color:#ddd;
		margin:5px;
		min-width:400px;
		flex:1;
		border:1px solid #888;
		box-shadow:3px 3px 1px #888;
	}
	.toolset_title{
		font-family: 'Dosis', sans-serif;
		font-size:1.8rem;
		text-align:center;
		margin:0;
		background-color:#bbb;
		border-bottom:2px solid #aaa;
	}
	.toolset_content{
		margin:0;
	}
	.tools{
		width:100%;
		border-collapse:collapse;
	}
	.tool{
		border-bottom:1px solid #aaa;
	}
	.tool_label{
		padding-left:20px;
		font-weight:bold;
	}
	.tool_action{
		display:inline-block;
		float:right;
		padding-right:20px;
	}


	.spec_table_holder{
		margin-top:none;
		margin:20px;
		border:1px solid #888;
		border-radius:5px;
		overflow:hidden;
	}
	.spec_table{
		width:100%;
		border-collapse:collapse;
		background:white;
	}
	.spec_table_head{
		border-bottom:1px solid #888;
		display:table;
		width:100%;
		table-layout:fixed;
	}
	.spec_table_body{
		display:block;
		max-height:100px;
		overflow-y:auto;
	}
	.spec_table_row{
		display:table;
		width:100%;
		table-layout:fixed;
		border-top:1px solid #ccc;
	}
	.spec_row_name{
		overflow:auto;
	}
	.spec_row_color{
		width:20%;
	}
	.spec_row_show{
		width:20%;
	 	text-align:center;
	}

	.unselected_row:hover{
		cursor:pointer;
		background-color:rgba(122,199,255,.5);
	}
	.selected_row{
		background-color:#7ac7ff;
		font-weight:bold;
	}

	.showing_config{

	}
	.hidden_config{
		display:none;
	}

	.spectra_buttons{
		display:flex;
		flex-direction:row;
	}
	.spec_button{
		flex:1;
		font-size:2rem;
		border:1px solid #888;
		border-radius:5px;
		margin:5px;
		font-family: 'Open Sans', sans-serif;
		cursor:pointer;
		text-align:center;
	}
	.spec_button:focus{
		outline:none;
	}
	
	#add_spec{
		background-color:#77ee77;
	}
	#remove_spec{
		background-color:#ffb2b2;
	}
	

	/* the big button */
	#make_plot{
		font-family: 'Dosis', sans-serif;
		font-size:2rem;
		width:calc(100% - 40px);
		margin:10px 20px;
		border-radius:10px;
		background-color:#2c579e;
		color:#eee;
		cursor:pointer;
		border:1px solid #888;
		box-shadow:3px 3px 1px #888;
		min-width:400px;
	}
	#make_plot:focus{
		outline:none;
	}
	#make_plot:hover{
		background-color:#1f4077;
	}
	#make_plot:active{
		background-color:#002060;
	}

	.all_tools{
		display:flex;
		flex-direction:row;
		flex-wrap:wrap;
	}

	#plot_holder{
		margin:5px;
		height:50vh; /* default */
		display:flex;
		flex-direction:column;
		justify-content:center;
		background-position: center;
	    background-repeat: no-repeat;
	    background-size: cover;
	}
	#plot_placeholder{
		text-align:center;
		font-size:2rem;
	}
	.loading_text{
		margin:0;
	}


	/* modal window */
	.modal_bg{
		position:absolute;
		width:100%;
		height:100%;
		background:rgba(0,0,0,.7);
		display:flex;
		flex-direction:column;
		align-items:center;
		justify-content:center;
		z-index:11000;
	}
	.modal{
		display:flex;
		flex-direction:column;
		justify-content:center;
		background:#bbb;
		border-radius:5px;
		overflow:hidden;
		min-width:70vw;
	}
	.modal_title{
		text-align:center;
		width:100%;
		background:#999;
		padding:5px;
		margin-top:0;
		margin-bottom:0;
	}
	#modal_spec_name{
		min-width:15rem;
	}
	.modal_content{
		padding: 20px;
	}
	#cancel_modal{
		float:right;
	}

</style>
<link href="https://fonts.googleapis.com/css?family=Montserrat|Spectral+SC" rel="stylesheet">
{% endblock %}

{% block body %}
{% csrf_token %}

<style>
.tab{
	display:inline-block;
	border-top-left-radius:5px;
	border-top-right-radius:5px;
	border:1px solid #888;
	border-bottom:none;
	background:#bbb;
	cursor:pointer;
}
.tab:hover{
	background:#ccc;
}
.selected_tab{
	font-weight:bold;
	background:#ddd;
}
.selected_tab:hover{
	background:#ddd;
	cursor:default;
}
.modal_subtitle{
	margin: 5px;
}
.modal_option{
	background:#ddd;
	border:1px solid #888;
	padding:10px;
}
/* this one starts hidden */
#modal_db{
	display:none;
}

.database_table{
	width:100%;
	border-collapse:collapse;
}

#modal_db_thead{
	display:block;
	width:100%;
	background-color:#444;
	color:#eee;
	border-top-left-radius: 5px;
	border-top-right-radius: 5px;
}
#modal_db_tbody{
/* eventually make this scroll */
	display:block;
	width:calc(100% - 2px);
	max-height:50vh;
	overflow:auto;
	border:1px solid #888;
	border-bottom-left-radius: 5px;
	border-bottom-right-radius: 5px;
	border-top:none;
}

.modal_db_headrow{
	display:table;
	width:100%;
	cursor:pointer;
	border-bottom:1px solid #ccc;
	text-align:center;
}
.modal_db_row{
	display:table;
	width:100%;
	cursor:pointer;
	background:#fff;
	border-bottom:1px solid #ccc;
	text-align:center;
}
.modal_db_row:hover{
	background:#ccc;
}
.modal_db_id{
	width:10%;
}
.modal_db_name{
}
.modal_db_source{
	width:20%;
}
.modal_db_wv{
	width:20%;
}
</style>

<!-- modal -->
<div class="modal_bg">
	<script>
	// hide modal on page load (not the long-term solution)
	$('.modal_bg').hide();
	</script>
	<div class="modal">
		<h2 class="modal_title">Add Spectrum</h2>
		<div class="modal_content">
			<div class="tabs">
				<div class="tab selected_tab" id="csv_tab">
					<h3 class="modal_subtitle">Upload from CSV</h3>
				</div>
				<div class="tab" id="db_tab">
					<h3 class="modal_subtitle">Add from database</h3>
				</div>
			</div>
			<div class="modal_option" id="modal_csv">
				<!-- add by uploading csv -->
				<form id="modal_form">
					<input name=file type=file accept=".csv" id="spec_upload_file">
					<hr>
					<table>
						<tr>
							<td>Name</td>
							<td><input id="modal_spec_name" name=name></td>
						</tr>
					</table>
					<hr>
					<input type=submit value="Upload">
					<button id="cancel_modal">Cancel</button>
				</form>
			</div>
			<div class="modal_option" id="modal_db">
				<!-- adding from database - list all database options (for now, in one list) -->
				<table class="database_table">
					<thead id="modal_db_thead">
						<tr class="modal_db_headrow">
							<th class="modal_db_id">ID</th>
							<th class="modal_db_name">Name</th>
							<th class="modal_db_source">Source</th>
							<th class="modal_db_wv">Wavelength</th>
						</tr>
					</thead>
					<tbody id="modal_db_tbody">
						<!-- database spectra get filled in here -->
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<form id="plot_form">
	<div class="all_tools">
		<div class="toolset" id="global_tools">
			<h2 class="toolset_title">Global Tools</h2>
			
			<div id="pc_target" class="toolset_content">

			</div>

		</div>
		<div class="toolset" id="spectra_tools">
			<h2 class="toolset_title">Spectra Tools</h2>
			<div class="toolset_content">
				<!-- list of current spectra -->
				<div class="spec_table_holder">
					<table class="spec_table">
						<thead class="spec_table_head">
							<tr>
								<th class="spec_row_name">Name</th>
								<th class="spec_row_color">Color</th>
								<th class="spec_row_show">Showing</th>
							</tr>
						</thead>

						<tbody class="spec_table_body" id="sl_target">

						</tbody>

					</table>
				</div>

				<!-- buttons (add / remove) -->
				<!--
				<div class="spectra_buttons">
					<label class="spec_button" id="add_spec">
					    Add
					</label>

					<button class="spec_button" id="remove_spec">Remove</button>
				</div>
			-->

				<!-- tools associated with currently-selected spectrum -->
				<div id="sc_target">
				
				</div>

			</div>
		</div>
	</div>
	<!--
	<button id="make_plot">Make the plot!</button>
-->
</form>

<div class="toolset" id="plot_holder">
	<div id="plot_placeholder" style="display:none;"><img src={% static "plotbot/loading.gif" %} /><p class="loading_text">Loading...</p></div>
</div>

<script>

/* new plot page actions:
	- generate plot config html and insert into correct point in page
	- generate spec list html and insert into correct point in page
	- generate any spec config html and insert into correct point (hide all but one)
*/

var ph = new PlotHandler($('#pc_target'),$('#sl_target'),$('#sc_target'),$('#plot_holder'));

ph.initialize();



// modal window

// make the 'cancel' button in modal close the modal
$('#cancel_modal').click(function(){
	clearModal();
	$('.modal_bg').hide();
});

// set the default name to the file name when one is selected
$('#spec_upload_file').change(function(){
	var filename = $('#spec_upload_file').val().split('\\').reverse()[0];
	var specname = filename.slice(0,-4);
	$('#modal_spec_name').attr('value',specname);
});

// clear data from modal
function clearModal(){
	var modal = $('.modal');
	modal.find('#modal_spec_name').val('');
	modal.find('#spec_upload_file').val('');
}

// handle modal form submission
// parse csv, including checking that the domain is in output[0] and ordered low to high
$('#modal_form').submit(function(event){
	event.preventDefault(); // don't reload the page on form submit
	// parse the data in a filereader (it's async and it's reeeeal ugly)
	var wavs, counts;
	var lista = [];
	var listb = [];
	var reader = new FileReader;
	reader.onload = function(){
		// parse into lists
		var data = reader.result.split(/\r|\n/); // this regex is to make sure we don't run into the windows vs mac newline issue
		for(var i = 0; i < data.length; i++){
			try{
				var points = data[i].split(',');
				var to_a = parseFloat(points[0]);
				var to_b = parseFloat(points[1]);
				if(to_a && to_b){
					lista.push(to_a);
					listb.push(to_b);
				}
			}
			catch(err){
				console.log(err);
				console.log('skipped line: '+data[i]);
			}
		}
		// find the one that's going up or down by a consistent amount (assume it's the one where the point in the middle is closest to halfway between the start and end values. there's a very small chance this is wrong. TODO: fix this issue)
		// span is the difference between the first and last values
		var lista_span = lista[lista.length - 1] - lista[0]
		var listb_span = listb[listb.length - 1] - listb[0]
		// mid is the value in the middle
		var lista_mid = lista[lista.length / 2]
		var listb_mid = listb[listb.length / 2]
		// gap is the difference between the mid and half the span
		var lista_gap = Math.abs(lista_mid - (lista[0] + (lista_span/2)));
		var listb_gap = Math.abs(listb_mid - (listb[0] + (listb_span/2)));
		console.log('list a');
		console.log(lista);
		console.log(lista_mid);
		console.log(lista_gap);
		console.log('list b');
		console.log(listb)
		console.log(listb_mid);
		console.log(listb_gap);
		// the smaller gap is the wavenumbers
		if(lista_gap < listb_gap){
			wavs = lista;
			counts = listb;
		}
		else{
			wavs = listb;
			counts = lista;
		}
		// check if wavs (and therefore both) need reversing
		if(wavs[1] < wavs[0]){
			wavs.reverse();
			counts.reverse();
		}
		data = [wavs,counts];
		// get name input and then send it to the plothandler

		var specname = $('#modal_spec_name').val();
		ph.addSpec(specname, data);
		clearModal();
		$('.modal_bg').hide();
	}
	var file = document.querySelector('#spec_upload_file').files[0];
	reader.readAsText(file);
});

// returns a jquery html row, given a name and wavelength
function modalDbRow(id, name, source, wv){
	var wv_str;
	var src_str;
	var row = $('<tr>').addClass('modal_db_row');
	row.append($('<td>').addClass('modal_db_id').html(id));
	row.append($('<td>').addClass('modal_db_name').html(name));
	if(source != null){
		src_str = source;
	}
	else{
		src_str = 'Unknown';
	}
	row.append($('<td>').addClass('modal_db_source').html(src_str));
	if(wv != -1){
		wv_str = wv+'nm';
	}
	else{
		wv_str = 'Unknown';
	}
	row.append($('<td>').addClass('modal_db_wv').html(wv_str));
	return row;
}

$('.tab').click(function(){
	// set this tab class
	$('.selected_tab').removeClass('selected_tab');
	$(this).addClass('selected_tab');
	// set the correct modal_option
	$('.modal_option').hide();
	if($(this).attr('id') == 'csv_tab'){
		$('#modal_csv').show();
	}
	else{
		$('#modal_db').show();
	}
});

$(document).ready(function(){
	// load database into modal_db_tbody at page load (for now)
	{% for spec in specs %}
	$('#modal_db_tbody').append(modalDbRow('{{spec.spec_id}}', '{{spec.name}}', '{{spec.source}}', '{{spec.wavelength}}'));
	quick_add_list.push({'label':'{{spec.name}} - {{spec.wavelength}}nm','value':'{{spec.spec_id}}'});
	{% endfor %}
	// this has to go to the end because it's going to tie into plothandler and all those rows
	$('.modal_db_row').click(function(){
		var id = $(this).find('.modal_db_id').html();
		console.log(id);
		ph.addSpecByDbId(id);
		$('.modal_bg').hide();
		// add spectrum to plothandler
	});
});


// nothing below here matters if we're doing plotly (except for saving state sometime in the future)

// pass form data as json
$(function() {

	// This takes all settings and passes it over to the server, and then updates the plot holder with the image url returned by the server
	$('#plot_form').submit(function() {
		var form_data = $('#plot_form').serializeArray();
		to_json = {};
		for(var i = 0; i < form_data.length; i++)
			to_json[form_data[i]['name']] = form_data[i]['value'];
			string_data = JSON.stringify(to_json);
			// ajax the stringified data

			//$('#plot_placeholder').show();
			/*
			$.get({
				url:'make_plot',
				data:to_json,
				success:function(response){
					$('#plot_placeholder').hide();
					//$('#plot_holder').html('');
					$('#plot_holder').css('background-image', 'url('+response['img_url']+')');
					fitPlotDiv();
				}
			});
			*/
		return false; // don't reload the page
	});

	// This handles uploading 1+ new spectra. It is also garbage
	/*
	$('#add_spec [type=file]').on('change',function(){
		// loop through files and add to FormData object
		// FUTURE: keep a list of hashes of all available spectra, and don't bother re-uploading if the spectra is already in the database (that checking will get build in this time as well, but only server-side; going client-side with hashes will make it faster)
		var formData = new FormData();
		for(var i = 0; i < this.files.length; i++){
			var curFile = this.files[i];
			formData.append('spectra',curFile);
		}
		// set up XMLHttpRequest to transfer files to server
		var xhr = new XMLHttpRequest();
		xhr.open('POST', 'upload_spec', true);

		// Set up a handler for when the request finishes.
		xhr.onload = function () {
		  if (xhr.status === 200) {
		    // File(s) uploaded.
		    console.log('File(s) uploaded!')
		  } else {
		    alert('An error occurred =(');
		  }
		};

		// Send the Data.
		xhr.send(formData);

	});
	*/

	// This adds a new set of SpecConfig settings (for cleanliness, settings are handled entirely in HTML until it's time to transfer them to the server)

	// This removes a spectrum from the working set, including removing its SpecConfig

});
// re-fit the plot div when the window is resized
/*
$(window).on('resize',function(){
	fitPlotDiv();
});

// scales the height of the plot div so that it exactly fits the original plot dimensions with a fixed width
function fitPlotDiv(){
	var shown_width = $('#plot_holder').width();
	var img = new Image();
	img.src = $('#plot_holder').css('background-image').replace(/url\(|\)$|"/ig, '');
	$(img).on('load',function(){
		var shown_width = $('#plot_holder').width();
		var to_h = shown_width * img.height / img.width;
		$('#plot_holder').height(to_h);
	});
}
*/
</script>

{% endblock %}

